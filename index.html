<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidador de Dados de Abate</title>
    <!-- Carrega o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega o PapaParse para ler arquivos CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Carrega o SheetJS (xlsx) para ler arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilo para a fonte Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Adiciona setas de ordenação */
        th.sortable::after {
            content: ' \25B2\25BC';
            font-size: 0.8em;
            color: #9ca3af;
        }
        th.sortable.asc::after {
            content: ' \25B2';
            color: #1f2937;
        }
        th.sortable.desc::after {
            content: ' \25BC';
            color: #1f2937;
        }
    </style>
    <!-- Importa a fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
    <div class="container mx-auto p-4 sm:p-8 max-w-7xl">
        <header class="mb-8 p-6 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold text-gray-800">Consolidador e Analisador de Abate SIF</h1>
            <p class="text-gray-600 mt-2">Carregue seus arquivos CSV ou Excel (.xlsx) para consolidar tudo em uma única tabela interativa.</p>
        </header>

        <!-- Seção de Upload -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">1. Carregar Arquivos</h2>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <!-- Atualizado para aceitar .csv e .xlsx -->
                <input type="file" id="csvFiles" multiple accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100 cursor-pointer"
                >
                <p class="text-xs text-gray-500 mt-2">Você pode selecionar múltiplos arquivos (.csv ou .xlsx) de uma vez.</p>
            </div>
            <button id="processButton" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Consolidar e Exibir Dados
            </button>
        </div>

        <!-- Seção de Dados Consolidados -->
        <div id="dataSection" class="bg-white p-6 rounded-lg shadow-md hidden">
            <!-- ... (o restante da seção de dados é idêntico) ... -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-semibold">2. Tabela Super Completa</h2>
                <div class="flex gap-4">
                    <button id="downloadButton" class="bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow hover:bg-green-700 transition duration-300">
                        Baixar CSV Consolidado
                    </button>
                    <button id="clearButton" class="bg-red-600 text-white font-semibold py-2 px-5 rounded-lg shadow hover:bg-red-700 transition duration-300">
                        Limpar e Recomeçar
                    </button>
                </div>
            </div>
            
            <!-- Indicador de Carregamento -->
            <div id="loadingIndicator" class="text-center p-8 hidden">
                <p class="text-lg font-medium text-blue-600">Processando arquivos...</p>
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mt-4"></div>
            </div>

            <!-- Resumo dos Dados -->
            <div id="dataSummary" class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500">Total de Registros</p>
                    <p id="totalRows" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500">Total Abatido (Cabeças)</p>
                    <p id="totalQuantity" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500">Total Machos</p>
                    <p id="totalMacho" class="text-2xl font-bold"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                    <p class="text-sm font-medium text-gray-500">Total Fêmeas</p>
                    <p id="totalFemea" class="text-2xl font-bold"></p>
                </div>
            </div>

            <!-- Tabela Interativa -->
            <div id="tableContainer" class="w-full overflow-x-auto rounded-lg border border-gray-200 shadow-sm hidden">
                <table id="dataTable" class="w-full min-w-max">
                    <thead id="tableHeader" class="bg-gray-100 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                        <!-- Cabeçalho e filtros serão injetados aqui pelo JavaScript -->
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Dados da tabela serão injetados aqui -->
                    </tbody>
                </table>
            </div>
             <p id="noDataMessage" class="text-center text-gray-500 p-8 hidden">Nenhum dado encontrado nos arquivos.</p>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('csvFiles');
        const processButton = document.getElementById('processButton');
        const downloadButton = document.getElementById('downloadButton');
        const clearButton = document.getElementById('clearButton');
        const dataSection = document.getElementById('dataSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableContainer = document.getElementById('tableContainer');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const noDataMessage = document.getElementById('noDataMessage');
        
        // Sumário
        const dataSummary = document.getElementById('dataSummary');
        const totalRows = document.getElementById('totalRows');
        const totalQuantity = document.getElementById('totalQuantity');
        const totalMacho = document.getElementById('totalMacho');
        const totalFemea = document.getElementById('totalFemea');

        let allData = [];
        let tableHeaderFields = [];
        let sortColumn = -1;
        let sortDirection = 'asc';
        let filters = {};

        // 1. Processar os arquivos (CSV ou XLSX)
        processButton.addEventListener('click', () => {
            const files = fileInput.files;
            if (files.length === 0) {
                // Modificado para não usar alert
                showModal('Por favor, selecione pelo menos um arquivo CSV ou XLSX.');
                return;
            }

            // Resetar estado
            resetState();
            dataSection.classList.remove('hidden');
            loadingIndicator.classList.remove('hidden');
            
            const promises = Array.from(files).map(file => {
                return new Promise((resolve, reject) => {
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.csv')) {
                        // --- Lógica para CSV (PapaParse) ---
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                if (results.errors.length) {
                                    reject(results.errors);
                                } else {
                                    const fields = results.meta.fields.map(field => normalizeHeader(field));
                                    if (tableHeaderFields.length === 0) {
                                        tableHeaderFields = fields;
                                    }
                                    const formattedData = results.data.map(row => {
                                        let newRow = {};
                                        for(const field of results.meta.fields) {
                                            newRow[normalizeHeader(field)] = row[field];
                                        }
                                        return newRow;
                                    });
                                    resolve(formattedData);
                                }
                            },
                            error: (error) => reject(error)
                        });
                    } else if (fileName.endsWith('.xlsx')) {
                        // --- Lógica para XLSX (SheetJS) ---
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = e.target.result;
                                const workbook = XLSX.read(data, { type: 'array' });
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                                if (jsonData.length === 0) {
                                    resolve([]);
                                    return;
                                }

                                const fields = Object.keys(jsonData[0]).map(field => normalizeHeader(field));
                                if (tableHeaderFields.length === 0) {
                                    tableHeaderFields = fields;
                                }

                                const formattedData = jsonData.map(row => {
                                    let newRow = {};
                                    for(const field in row) {
                                        newRow[normalizeHeader(field)] = row[field];
                                    }
                                    return newRow;
                                });
                                resolve(formattedData);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = (error) => reject(error);
                        reader.readAsArrayBuffer(file);
                    } else {
                        // Arquivo não suportado
                        reject(new Error(`Formato de arquivo não suportado: ${file.name}`));
                    }
                });
            });

            Promise.all(promises)
                .then(results => {
                    allData = results.flat(); // Junta os dados de todos os arquivos
                    loadingIndicator.classList.add('hidden');

                    if (allData.length > 0) {
                        // Garante que os cabeçalhos são consistentes (pega de todos os dados)
                        const allKeys = new Set();
                        allData.forEach(row => Object.keys(row).forEach(key => allKeys.add(key)));
                        tableHeaderFields = Array.from(allKeys);
                        
                        renderTableHeader();
                        applyFiltersAndSort(); // Renderiza a tabela com os dados
                        updateSummary();
                        tableContainer.classList.remove('hidden');
                        dataSummary.classList.remove('hidden');
                    } else {
                        noDataMessage.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    loadingIndicator.classList.add('hidden');
                    console.error('Erro ao processar arquivos:', error);
                    // Modificado para não usar alert
                    showModal(`Ocorreu um erro ao ler os arquivos: ${error.message}. Verifique o console para mais detalhes.`);
                });
        });

        // 2. Normalizar Cabeçalhos (remove caracteres estranhos)
        function normalizeHeader(header) {
            // Remove caracteres inválidos, mas mantém / e espaço
            return header.replace(/[^a-zA-Z0-9/ ]/g, "").trim();
        }
        
        // 3. Renderizar o Cabeçalho da Tabela e Filtros
        function renderTableHeader() {
            tableHeader.innerHTML = '';
            
            // Linha de Títulos (para ordenação)
            const titleRow = document.createElement('tr');
            tableHeaderFields.forEach((field, index) => {
                const th = document.createElement('th');
                th.className = 'px-6 py-4 cursor-pointer hover:bg-gray-200 sortable';
                th.textContent = field;
                th.dataset.index = index;
                
                if(index === sortColumn) {
                    th.classList.add(sortDirection);
                }

                th.addEventListener('click', () => {
                    if (sortColumn === index) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = index;
                        sortDirection = 'asc';
                    }
                    
                    // Atualiza classes CSS
                    document.querySelectorAll('#tableHeader th').forEach(h => h.classList.remove('asc', 'desc'));
                    th.classList.add(sortDirection);
                    
                    applyFiltersAndSort();
                });
                titleRow.appendChild(th);
            });
            tableHeader.appendChild(titleRow);

            // Linha de Filtros
            const filterRow = document.createElement('tr');
            filterRow.className = 'bg-gray-50';
            tableHeaderFields.forEach((field, index) => {
                const td = document.createElement('td');
                td.className = 'px-4 py-2';
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `Filtrar ${field}...`;
                input.className = 'w-full px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500';
                input.dataset.index = index;
                
                input.addEventListener('keyup', (e) => {
                    filters[index] = e.target.value.toLowerCase();
                    applyFiltersAndSort();
                });
                td.appendChild(input);
                filterRow.appendChild(td);
            });
            tableHeader.appendChild(filterRow);
        }

        // 4. Aplicar Filtros e Ordenação, e Renderizar Corpo da Tabela
        function applyFiltersAndSort() {
            let filteredData = [...allData];

            // Aplicar Filtros
            Object.keys(filters).forEach(key => {
                const filterValue = filters[key];
                if (filterValue) {
                    filteredData = filteredData.filter(row => {
                        const cellValue = row[tableHeaderFields[key]];
                        return cellValue && String(cellValue).toLowerCase().includes(filterValue);
                    });
                }
            });

            // Aplicar Ordenação
            if (sortColumn !== -1) {
                const fieldName = tableHeaderFields[sortColumn];
                // Tenta comparar como números (especialmente para 'Quantidade')
                const isNumericColumn = fieldName.toLowerCase().includes('quantidade');

                filteredData.sort((a, b) => {
                    let valA = a[fieldName];
                    let valB = b[fieldName];

                    if(isNumericColumn) {
                        valA = parseFloat(valA) || 0;
                        valB = parseFloat(valB) || 0;
                    } else {
                        valA = String(valA).toLowerCase();
                        valB = String(valB).toLowerCase();
                    }

                    if (valA < valB) {
                        return sortDirection === 'asc' ? -1 : 1;
                    }
                    if (valA > valB) {
                        return sortDirection === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            renderTableBody(filteredData);
        }

        // 5. Renderizar o Corpo da Tabela
        function renderTableBody(data) {
            tableBody.innerHTML = ''; // Limpa o corpo da tabela
            
            if (data.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="${tableHeaderFields.length}" class="text-center p-8 text-gray-500">Nenhum resultado encontrado para os filtros aplicados.</td></tr>`;
                 return;
            }

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                tableHeaderFields.forEach(field => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                    td.textContent = row[field] || ''; // Usa o campo normalizado
                    
                    // Alinha 'Quantidade' à direita
                    if (field.toLowerCase().includes('quantidade')) {
                        td.classList.add('text-right', 'font-medium');
                        td.textContent = (parseInt(row[field]) || 0).toLocaleString('pt-BR');
                    }
                    
                    // Formata datas Mês/Ano se vierem do Excel como números
                    if (field.toLowerCase().includes('mês/ano') && typeof row[field] === 'number' && row[field] > 40000) {
                        // Tenta converter data serial do Excel (simplificado)
                        const date = new Date(Math.round((row[field] - 25569) * 86400 * 1000));
                        const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
                        const year = date.getUTCFullYear();
                        td.textContent = `${month}/${year}`;
                    }


                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        // 6. Atualizar Resumo
        function updateSummary() {
            const formatter = new Intl.NumberFormat('pt-BR');
            let totalQty = 0;
            let totalM = 0;
            let totalF = 0;
            
            // Pega os nomes corretos das colunas (já normalizados)
            const sexoField = tableHeaderFields.find(f => f.toLowerCase().includes('sexo'));
            const qtdField = tableHeaderFields.find(f => f.toLowerCase().includes('quantidade'));

            if (!qtdField) {
                console.warn("Não foi possível encontrar a coluna 'Quantidade' para o resumo.");
                return;
            }

            allData.forEach(row => {
                const qty = parseInt(row[qtdField]) || 0;
                totalQty += qty;
                
                if (sexoField && row[sexoField] && String(row[sexoField]).toLowerCase().includes('macho')) {
                    totalM += qty;
                } else if (sexoField && row[sexoField] && String(row[sexoField]).toLowerCase().includes('fêmea')) {
                    totalF += qty;
                }
            });

            totalRows.textContent = formatter.format(allData.length);
            totalQuantity.textContent = formatter.format(totalQty);
            totalMacho.textContent = formatter.format(totalM);
            totalFemea.textContent = formatter.format(totalF);
        }

        // 7. Botão de Download
        downloadButton.addEventListener('click', () => {
            if (allData.length === 0) {
                showModal('Não há dados para baixar.');
                return;
            }

            // Converte os dados (array de objetos) para o formato que o PapaParse espera (array de arrays)
            const csvData = allData.map(row => {
                return tableHeaderFields.map(field => row[field] || ''); // Garante que valores nulos se tornem strings vazias
            });
            
            // Adiciona o cabeçalho
            csvData.unshift(tableHeaderFields);

            const csvString = Papa.unparse(csvData);
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'dados_consolidados.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // 8. Limpar e Recomeçar
        clearButton.addEventListener('click', () => {
            resetState();
            fileInput.value = ''; // Limpa a seleção de arquivos
        });
        
        // 9. Função para resetar o estado da UI
        function resetState() {
            allData = [];
            tableHeaderFields = [];
            filters = {};
            sortColumn = -1;
            sortDirection = 'asc';

            dataSection.classList.add('hidden');
            tableContainer.classList.add('hidden');
            dataSummary.classList.add('hidden');
            noDataMessage.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
        }
        
        // 10. Função para mostrar modal (substitui o alert)
        function showModal(message) {
            // Remove modal existente se houver
            const existingModal = document.getElementById('alertModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Cria o modal
            const modal = document.createElement('div');
            modal.id = 'alertModal';
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';
            
            modal.innerHTML = `
                <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Aviso</h3>
                        <div class="mt-2 px-7 py-3">
                            <p class="text-sm text-gray-500">${message}</p>
                        </div>
                        <div class="items-center px-4 py-3">
                            <button id="closeModalButton" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                OK
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('closeModalButton').onclick = function() {
                modal.remove();
            }
             modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            }
        }

    </script>
</body>
</html>
